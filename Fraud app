import streamlit as st
import pandas as pd
import numpy as np
import joblib
from sklearn.preprocessing import StandardScaler, OneHotEncoder
from sklearn.compose import make_column_transformer
from sklearn.pipeline import Pipeline
from sklearn.ensemble import GradientBoostingClassifier

# Custom imports (you'll need to upload these with your app)
# Assuming you have a preprocessing script or module
# from preprocessing import get_predictors, get_categorical_cols, get_continuous_cols

# Configure Streamlit page
st.set_page_config(
    page_title="Fraud Detection Predictor", 
    page_icon="üí≥", 
    layout="wide"
)

# Constants (match these with your original model training)
FRAUD_THRESHOLD = 0.30
RANDOM_STATE = 123

# Helper Functions
def load_model(model_path='best_fraud_model.joblib'):
    """
    Load the pre-trained model
    Note: You'll need to save your model using joblib after training
    """
    return joblib.load(model_path)

def preprocess_data(df, predictors, categorical, contin):
    """
    Preprocess input data using the same transformer used in training
    """
    # Create column transformer
    pre = make_column_transformer(
        (StandardScaler(), contin),
        (OneHotEncoder(handle_unknown='ignore'), categorical),
        remainder="passthrough"
    )
    
    # Select only the predictors used during training
    X = df[predictors]
    return X

def predict_fraud(model, X):
    """
    Predict fraud probabilities and apply custom threshold
    """
    # Get probability scores
    y_proba = model.predict_proba(X)[:, 1]
    
    # Apply custom threshold
    y_pred = (y_proba > FRAUD_THRESHOLD).astype(int)
    
    return y_proba, y_pred

def main():
    st.title("üïµÔ∏è Fraud Detection Predictor")
    
    # Sidebar for model and data configuration
    st.sidebar.header("Model Configuration")
    
    # File uploader
    uploaded_file = st.sidebar.file_uploader(
        "Upload CSV File for Fraud Prediction", 
        type=['csv'],
        help="Upload a CSV file with the same columns used during model training"
    )
    
    # Model loading
    try:
        model = load_model()
        st.sidebar.success("Model Loaded Successfully!")
    except Exception as e:
        st.sidebar.error(f"Error loading model: {e}")
        return

    # Main prediction workflow
    if uploaded_file is not None:
        try:
            # Read the uploaded file
            df = pd.read_csv(uploaded_file)
            
            # TODO: IMPORTANT - Replace these with your actual column configurations
            predictors = [
                'transaction_amount', 'is_international', 
                'time_of_day', 'merchant_category'
            ]
            categorical = ['is_international', 'merchant_category']
            contin = ['transaction_amount', 'time_of_day']
            
            # Preprocess data
            X = preprocess_data(df, predictors, categorical, contin)
            
            # Predict
            probabilities, predictions = predict_fraud(model, X)
            
            # Add results to dataframe
            df['fraud_probability'] = probabilities
            df['is_predicted_fraud'] = predictions
            
            # Display results
            st.subheader("Prediction Results")
            
            # Metrics
            total_records = len(df)
            predicted_fraud = sum(predictions)
            fraud_percentage = (predicted_fraud / total_records) * 100
            
            col1, col2, col3 = st.columns(3)
            col1.metric("Total Records", total_records)
            col2.metric("Predicted Fraudulent", predicted_fraud)
            col3.metric("Fraud Percentage", f"{fraud_percentage:.2f}%")
            
            # Detailed results table
            st.dataframe(df)
            
            # Download results
            csv = df.to_csv(index=False)
            st.download_button(
                label="Download Predictions",
                data=csv,
                file_name='fraud_predictions.csv',
                mime='text/csv'
            )
            
        except Exception as e:
            st.error(f"Error processing file: {e}")

# Streamlit app entry point
if __name__ == '__main__':
    main()
